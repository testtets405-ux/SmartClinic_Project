<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تفصيل الموجه الرئيسي والكنترولر (app.py) - التوثيق الشامل للعيادة الذكية</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&family=Fira+Code:wght@400;600&display=swap"
    rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- Highlight.js for Code Snippets -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Tajawal', 'sans-serif'],
            mono: ['"Fira Code"', 'monospace'],
          },
          colors: {
            brand: { 50: '#eff6ff', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
            dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' }
          }
        }
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
            .glass-header { @apply bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800; }
            .content-card { @apply bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 shadow-sm rounded-2xl p-6 mb-8; }
            .prose-custom h2 { @apply text-2xl font-black text-slate-800 dark:text-white mb-4 mt-8 pb-2 border-b border-slate-200 dark:border-slate-700; }
            .prose-custom h3 { @apply text-xl font-bold text-slate-700 dark:text-slate-200 mb-3 mt-6; }
            .prose-custom p { @apply text-slate-600 dark:text-slate-300 mb-4 leading-relaxed; }
            .prose-custom ul { @apply list-disc list-inside text-slate-600 dark:text-slate-300 mb-4 space-y-1; }
            .prose-custom ol { @apply list-decimal list-inside text-slate-600 dark:text-slate-300 mb-4 space-y-1; }
            .prose-custom code:not(pre code) { @apply bg-slate-100 dark:bg-slate-900 text-rose-500 dark:text-rose-400 px-1 py-0.5 rounded text-sm font-mono border border-slate-200 dark:border-slate-700; }
            .prose-custom strong { @apply text-slate-800 dark:text-white font-bold; }
            .prose-custom table { @apply w-full border-collapse border border-slate-200 dark:border-slate-700 mb-6 text-sm; }
            .prose-custom th { @apply p-3 bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white font-bold text-right; }
            .prose-custom td { @apply p-3 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300; }
        }
        body { @apply bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-200; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { @apply bg-slate-100 dark:bg-slate-900; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-300 dark:bg-slate-700 rounded; }
        ::-webkit-scrollbar-thumb:hover { @apply bg-slate-400 dark:bg-slate-600; }

        .nav-btn {
            @apply flex items-center gap-3 w-full text-right px-4 py-3 rounded-xl text-slate-600 dark:text-slate-400 font-medium transition-all duration-200;
        }
        .nav-btn:hover { @apply bg-slate-100 dark:bg-slate-800 text-blue-600 dark:text-blue-400; }
        .nav-btn.active { @apply bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 font-bold border-r-4 border-blue-600 dark:border-blue-500; }
        
        .code-block-wrapper { @apply relative mt-4 mb-6 rounded-xl overflow-hidden border border-slate-800; }
        .code-header { @apply bg-slate-900 text-slate-400 px-4 py-2 text-xs font-mono flex justify-between items-center border-b border-slate-700; }
        .copy-btn { @apply text-slate-400 hover:text-white hover:bg-slate-700 px-2 py-1 rounded transition-colors duration-200; }
        pre { margin: 0 !important; border-radius: 0 !important; }
    </style>

  <script>
    // Theme initialization
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  </script>
</head>

<body class="antialiased font-sans">

  <!-- Header -->
  <header class="glass-header sticky top-0 z-50 h-16 flex items-center px-6">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
          <i class="bi bi-journal-code text-xl"></i>
        </div>
        <h1 class="text-xl font-black tracking-tight">التوثيق الأكاديمي الشامل</h1>
      </div>
      <div class="flex items-center gap-4">
        <p class="text-sm text-slate-500 dark:text-slate-400 hidden md:block border-l dark:border-slate-700 pl-4">
          العيادة الذكية</p>
        <button id="theme-toggle"
          class="p-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
          <i class="bi bi-moon-stars-fill hidden dark:block"></i>
          <i class="bi bi-sun-fill dark:hidden"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8">

    <!-- Sidebar Navigation -->
    <aside class="w-full lg:w-1/4 shrink-0">
      <div
        class="sticky top-24 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm">
        <h3 class="text-xs font-black uppercase text-slate-400 dark:text-slate-500 mb-4 px-4 tracking-wider">محتويات
          الدليل</h3>
        <nav class="flex flex-col gap-1 space-y-1">
          
        <a href="index.html" class="nav-btn ">
            <i class="bi bi-bookmark-star-fill text-blue-500"></i> 1. النظرة العامة
        </a>
        <a href="structure.html" class="nav-btn ">
            <i class="bi bi-folder-fill text-amber-500"></i> 2. هيكلية المشروع الشاملة
        </a>
        <a href="app_py.html" class="nav-btn active">
            <i class="bi bi-router-fill text-emerald-500"></i> 3. المُوجه و الـ Routes (app.py)
        </a>
        <a href="models.html" class="nav-btn ">
            <i class="bi bi-diagram-3-fill text-fuchsia-500"></i> 4. الجداول والعلاقات (models.py)
        </a>
        <a href="utils.html" class="nav-btn ">
            <i class="bi bi-calculator-fill text-red-500"></i> 5. خوارزميات الطابور (utils.py)
        </a>
        <a href="ai_engine.html" class="nav-btn ">
            <i class="bi bi-robot text-indigo-500"></i> 6. الذكاء الاصطناعي (ai_service.py)
        </a>
        <a href="clock_config.html" class="nav-btn ">
            <i class="bi bi-shield-check text-teal-500"></i> 7. الزمن والأمان (clock / config)
        </a>
        <a href="templates.html" class="nav-btn ">
            <i class="bi bi-window-sidebar text-sky-500"></i> 8. واجهات المستخدم (Templates)
        </a>
        <a href="deployment.html" class="nav-btn ">
            <i class="bi bi-rocket-takeoff-fill text-yellow-500"></i> 9. التشغيل والرفع (مجاني بالكامل)
        </a>
        </nav>
        <div
          class="mt-8 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800 text-center">
          <i class="bi bi-shield-check text-slate-400 dark:text-slate-500 text-2xl mb-2 block"></i>
          <p class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed">هذا التوثيق مبني تلقائياً ومفصول تماماً
            عن خادم فلاسك الأساسي.</p>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="w-full lg:w-3/4 pb-32">
      <div class="mb-8">
        <h2 class="text-4xl font-black text-slate-800 dark:text-white mb-3 tracking-tight">تفصيل الموجه الرئيسي والكنترولر (app.py)</h2>
        <p class="text-lg text-slate-500 dark:text-slate-400">دليل دراسي شامل لكل مسار (Route) في النظام وكيف تم تأمينها بالديكوريتورز.</p>
      </div>

      <div class="content-card prose-custom">
        
            <div class="space-y-6">
                <p class="text-slate-600 dark:text-slate-300">
                    ملف <code>app.py</code> أطول ملف في المشروع. هو العقل المدبر الذي يربط بين جداول قاعدة البيانات (Models) وبين واجهات الاستخدام (Templates). ويقوم باستقبال وإرسال جميع الطلبات (Requests).
                </p>

                <div class="bg-indigo-50/50 dark:bg-indigo-900/10 p-5 rounded-xl border border-indigo-100 dark:border-indigo-800">
                    <h3 class="font-bold text-slate-800 dark:text-white mb-2">الدوال الجدارية وتحديث الطابور</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">يحتوي الكود على آليات حماية وتحديث آلية وتعتبر من الركائز التي بُني عليها المشروع:</p>
                    
                    <div class="code-block-wrapper">
                        <div class="code-header">
                            <span><i class="bi bi-file-earmark-code"></i> app.py (السطر 78) - حائط الصد المنيع (role_required)</span>
                            <button class="copy-btn" onclick="copyCode(this)"><i class="bi bi-clipboard"></i> نسخ</button>
                        </div>
                        <pre><code class="language-python">def role_required(*roles):
    """
    [المعنى الهندسي]: 
    الـ Decorator هو دالة تغلف دالة أخرى. نضعه فوق أي صفحة (route) نريد حمايتها.
    إذا حاول دكتور الدخول لصفحة الاستقبال، سيتحقق الـ Current User من الـ (Role) الخاص به
    ويمنعه من الدخول، وهذا يمنع أي متطفل من استخدام روابط مباشرة (Direct Links).
    """
    def decorator(view_func):
        @wraps(view_func)
        def wrapped(*args, **kwargs):
            if not current_user.is_authenticated:
                return redirect(url_for("login"))
            if current_user.role not in roles:
                flash("عذراً، لا تملك صلاحية للوصول إلى هذه الصفحة.", "danger")
                return redirect(url_for("home"))
            return view_func(*args, **kwargs)
        return wrapped
    return decorator</code></pre>
                    </div>

                    <div class="code-block-wrapper mt-4">
                        <div class="code-header">
                            <span><i class="bi bi-file-earmark-code"></i> app.py (السطر 49) - المحدث الآلي (update_priorities)</span>
                            <button class="copy-btn" onclick="copyCode(this)"><i class="bi bi-clipboard"></i> نسخ</button>
                        </div>
                        <pre><code class="language-python">def update_queue_priorities():
    """
    [المعنى الهندسي]:
    مستحيل أن نجعل الموظف يقوم بالضغط على (تحديث) يدوياً لكل مريض. 
    تقوم هذه الدالة دورياً بجلب كل المرضى (صاحبي حالة الانتظار)، 
    ثم تطرح وقت وصولهم من الوقت الحالي لتعرف (كم دقيقة انتظر المريض) 
    وتقوم بإعادة إرسال الرقم لخوارزمية الطابور لإعادة التنقيط بشكل ديناميكي مذهل وحي.
    """
    waiting_patients = Patient.query.filter_by(status='waiting').all()
    current_time = now_utc()
    for p in waiting_patients:
        wait_time = (current_time - p.check_in_time).total_seconds() / 60
        p.priority_score = calculate_priority(p.age, p.appointment_type, int(wait_time))
    db.session.commit()</code></pre>
                    </div>
                </div>

                <div class="bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
                    <h3 class="font-bold text-slate-800 dark:text-white mb-4 text-xl border-b border-slate-200 dark:border-slate-700 pb-2">سجل المسارات والراوتس (Routes Definitions)</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">تم تقسيم الروابط (Endpoints) في النظام لخدمة واجهات العيادة المختلفة. هذه بعض أهم الراوتس وماذا تفعل:</p>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-start">
                            <thead class="bg-slate-100 dark:bg-slate-700/50 text-slate-600 dark:text-slate-300">
                                <tr>
                                    <th class="p-3 border-b dark:border-slate-600">المسار (Route)</th>
                                    <th class="p-3 border-b dark:border-slate-600">الصلاحيات (Roles)</th>
                                    <th class="p-3 border-b dark:border-slate-600 text-right">الوظيفة (Functionality)</th>
                                </tr>
                            </thead>
                            <tbody class="text-slate-700 dark:text-slate-300 divide-y divide-slate-200 dark:divide-slate-700">
                                <tr>
                                    <td class="p-3 font-mono text-xs"><code>/</code></td>
                                    <td class="p-3"><span class="bg-slate-200 dark:bg-slate-600 px-2 py-1 rounded text-xs">الكل (Public)</span></td>
                                    <td class="p-3 text-right">الصفحة الرئيسية واجهة العيادة الترحيبية وتوجيه للأقسام.</td>
                                </tr>
                                <tr>
                                    <td class="p-3 font-mono text-xs text-blue-500"><code>/kiosk</code></td>
                                    <td class="p-3"><span class="bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 px-2 py-1 rounded text-xs">استقبال / مسؤول</span></td>
                                    <td class="p-3 text-right">واجهة الإدخال، تسأل عن بيانات المريض وتاريخه الطبي وحالته وتمررها للخوارزمية.</td>
                                </tr>
                                <tr>
                                    <td class="p-3 font-mono text-xs text-amber-500"><code>/queue</code></td>
                                    <td class="p-3"><span class="bg-slate-200 dark:bg-slate-600 px-2 py-1 rounded text-xs">الكل (Public)</span></td>
                                    <td class="p-3 text-right">الشاشة الذكية المعلقة في صالة الانتظار. تعرض الدور والمدة المتبقية بالاعتماد السري على API حي.</td>
                                </tr>
                                <tr>
                                    <td class="p-3 font-mono text-xs text-emerald-500"><code>/api/queue</code></td>
                                    <td class="p-3"><span class="bg-slate-200 dark:bg-slate-600 px-2 py-1 rounded text-xs">الكل (API)</span></td>
                                    <td class="p-3 text-right">واجهة برمجية تعيد قائمة المرضى كـ JSON للعمل مع شاشة العرض (تقوم بالتحديث الآلي).</td>
                                </tr>
                                <tr>
                                    <td class="p-3 font-mono text-xs text-red-500"><code>/doctor</code></td>
                                    <td class="p-3"><span class="bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300 px-2 py-1 rounded text-xs">دكتور / مسؤول</span></td>
                                    <td class="p-3 text-right">واجهة الطبيب. تعرض المريض الحالي الذي يجب فحصه، والمريض المستعد دخولاً خلفه، وتُعطي صلاحيات إنهاء المواعيد وتسجيل الملاحظات.</td>
                                </tr>
                                <tr>
                                    <td class="p-3 font-mono text-xs text-fuchsia-500"><code>/admin</code></td>
                                    <td class="p-3"><span class="bg-fuchsia-100 text-fuchsia-800 dark:bg-fuchsia-900/30 dark:text-fuchsia-300 px-2 py-1 rounded text-xs">المدير (admin)</span></td>
                                    <td class="p-3 text-right">لوحة التحكم العليا. لإنشاء الحسابات، عرض تاريخ كل العيادة وتشخيصات كل طبيب ورؤية التحليلات والإحصائيات الحيوية.</td>
                                </tr>
                                <tr>
                                    <td class="p-3 font-mono text-xs text-pink-500"><code>/api/ai_insights</code></td>
                                    <td class="p-3"><span class="bg-fuchsia-100 text-fuchsia-800 dark:bg-fuchsia-900/30 dark:text-fuchsia-300 px-2 py-1 rounded text-xs">المدير (admin)</span></td>
                                    <td class="p-3 text-right">استدعاء رياضي لمعلومات إحصائية يقوم الموديل فيها بإعطاء نصائح للإدارة (مثل: "زيادة الضغط في الصباح، يُنصح بتوفير أطباء دعم").</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        
      </div>
    </main>
  </div>

  <script>
    // Initialize Code Highlighting
    hljs.highlightAll();

    // Theme Toggle Logic
    const themeToggleBtn = document.getElementById('theme-toggle');
    themeToggleBtn.addEventListener('click', function () {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.theme = 'light';
      } else {
        document.documentElement.classList.add('dark');
        localStorage.theme = 'dark';
      }
    });

    // Copy Code Logic
    function copyCode(btn) {
      const pre = btn.parentElement.nextElementSibling;
      const code = pre.innerText;

      navigator.clipboard.writeText(code).then(() => {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check2"></i> تم النسخ';
        btn.classList.add('text-green-400');
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.classList.remove('text-green-400');
        }, 2000);
      });
    }
  </script>

</body>

</html>