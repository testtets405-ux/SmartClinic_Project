"""
================================================================================
مكتبة إدارة الزمن والتوقيت (clock.py)
================================================================================
الهدف المنهجي (للطالب):
معالجة الوقت (Timezones) تُعد من أخطر المشاكل الهندسية في بناء أنظمة الحجوزات الطبية.
لو تم رفع المشروع على سيرفر في أمريكا (توقيت شرق أمريكا EST) ورصدنا حجز مريض الساعة 
12:00 ظهراً بتوقيت العراق، فإن دالة (datetime.now) ستعتمد توقيت السيرفر وتسجلها 4:00 فجراً!
هذا سيؤدي لفشل النظام الإحصائي وخوارزميات الذكاء الاصطناعي التي تعتمد على دراسة الزحام 
حسب ساعات اليوم.

[الحل الهندسي المُنفذ هنا]:
1. نقوم بتسجيل الأوقات في قاعدة البيانات دائماً وأبداً بصيغة (UTC Standard) الموحدة عالمياً.
2. لا يتم إظهار وقت UTC للمستخدم في العيادة أبداً! بل نقوم باستدعاء الدوال في هذا 
   الملف التي تقوم بتحويل الوقت من UTC إلى (Iraq/Baghdad +3) وعرضه كنص، سواء على الفلاسك 
   أو داخل قوالب الـ HTML كـ (Filter).
================================================================================
"""

from datetime import datetime, timezone
try:
    # [ملاحظة]: في الإصدارات الحديثة لبايثون 3.9 وما فوق، أصبحت مكتبة المناطق الزمنية مدمجة
    from zoneinfo import ZoneInfo
except ImportError:
    # [ملاحظة]: للإصدارات القديمة يمكن استخدام هذه المكتبة كحل بديل
    from backports.zoneinfo import ZoneInfo

# ── منطقة توقيت بغداد (UTC+3، لا يوجد نظام صيفي/شتوي) ──
# تخزين المنطقة الزمنية ككائن دائم لكي لا يتم إعادة معالجتها في كل استدعاء لتوفير الموارد.
BAGHDAD = ZoneInfo("Asia/Baghdad")


def now_utc() -> datetime:
    """
    [الفائدة الأكاديمية]:
    تُعطي الوقت الحالي بتوقيت جرينتش (UTC). 
    يتم استخدامها حصراً عندما نريد إنشاء مريض جديد أو رفع موعد في قاعدة البيانات.
    لا تستخدم دالة (datetime.now) العادية أبداً لتفادي اختلاف توقيت سيرفر التشغيل.
    """
    return datetime.now(timezone.utc)


def now_local() -> datetime:
    """
    [الفائدة الأكاديمية]:
    تُعطي الوقت الحالي بتوقيت بغداد مباشرةً لمن يحتاجه للعرض السريع (ليس للحفظ في DB).
    """
    return datetime.now(BAGHDAD)


def to_local(dt: datetime) -> datetime:
    """
    [الفائدة الأكاديمية - المحرك الرئيسي]:
    هذه الدالة تستقبل وقت المريض المسجل في قاعدة البيانات (الذي هو UTC).
    وتقوم بتحليله، وتتأكد أنه يحمل بصمة الـ UTC، ثم تقوم بضخه وتحويله إلى توقيت بغداد.
    
    المدخلات (Args): 
        dt: كائن من نوع datetime مستخرج من الـ DB.
    المخرجات (Returns): 
        كائن datetime يحمل وقت وتوقيت بغداد الحقيقي.
    """
    if dt is None:
        return dt
    
    # [الشرط الهندسي]: إذا حفظ SQLite الوقت بدون تحديد المنطقة (Naive) سنفرض يدوياً أنه UTC.
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
        
    # الأمر astimezone يقرأ الفارق الزمني ويضيف الساعات المناسبة
    return dt.astimezone(BAGHDAD)


def fmt_local(dt: datetime, fmt: str = "%I:%M %p") -> str:
    """
    [الفائدة الأكاديمية]:
    تأخذ الوقت بعد تحويله، وتقوم بـ "هيكلته" كنص بشري مقروء (مثال: 08:30 PM).
    يقبل الكود تعديل شكل الصياغة عن طريق معامل (fmt) وهو يتبع معايير String Format Time.
    """
    if dt is None:
        return "—"
    local = to_local(dt)
    return local.strftime(fmt)



def wait_duration_str(check_in_utc: datetime) -> str:
    """
    [الفائدة الأكاديمية - دالة الانتظار البشري]:
    عوضاً عن أن نكتب للمريض (وقت وصولك 10:00 والان الساعة 11:30) لنجعلها أسهل للقراءة
    برمجناها لتقول: (انتظرت: ساعة و 30 دقيقة).
    
    العملية الحسابية:
    1. نأتي بالوقت الحالي UTC 
    2. نطرحه من وقت الوصول UTC فنحصل على فرق ثواني (Delta)
    3. نقسم الساعات والدقائق رياضياً باستخدام عامل الباقي (%).
    """
    if check_in_utc is None:
        return "غير متاح"
        
    # ضمان وجود بصمة توقيت على البيانات
    dt = check_in_utc
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
        
    now = now_utc()
    delta = now - dt # نتيجة الطرح هي كائن يُدعى TimeSpan/Timedelta
    
    # قسمة إجمالي الثواني للحصول على عدد الدقائق الكاملة التراكمية، ومنعها من أن تكون سالبة.
    total_minutes = max(0, int(delta.total_seconds() // 60))
    hours = total_minutes // 60
    mins = total_minutes % 60
    
    # بناء الرد النصي الذكي
    if hours > 0 and mins > 0:
        return f"{hours} ساعة و {mins} دقيقة"
    elif hours > 0:
        return f"{hours} ساعة"
    elif mins > 0:
        return f"{mins} دقيقة"
    return "الآن"
