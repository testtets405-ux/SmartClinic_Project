{% extends "layout.html" %}
{% block title %}العيادة الذكية — لوحة الطبيب{% endblock %}

{% block content %}
<!-- 
================================================================================
لوحة تحكم الطبيب المعالج (doctor.html)
================================================================================
الهدف المنهجي (للطالب):
تمثل هذه الشاشة (مساحة العمل) الخاصة بالطبيب لتقليل التشتت.
بدلاً من رؤية طابور طويل وصاخب، يرى الطبيب ثلاثة أشياء رئيسية فقط:
1. المريض الحالي (In Progress): المريض المتواجد داخل الغرفة، ويكتب الطبيب تشخيصه هنا.
2. المريض التالي (Next Up): ليعرف من سيدخل، ومجال تخصصه، ومراقبة أولوية الطوارئ.
3. التخريج والحفظ (Finish & Save): زر حفظ ينقل حالة المريض لـ (Done) ويخزن نص 
   التشخيص بأمان في جدول الـ(Appointments) في قاعدة البيانات للعودة إليه لاحقاً.
================================================================================
-->
<h3 class="section-header animate-fade-in">
  <div class="p-3 bg-blue-600/10 dark:bg-blue-600/20 rounded-xl me-4 text-blue-600 dark:text-blue-500">
    <i class="bi bi-clipboard2-pulse-fill text-2xl"></i>
  </div>
  لوحة تحكم الطبيب
</h3>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- ─── Current Patient (large, prominent) ─── -->
  <div class="lg:col-span-2">
    {% if current %}
    <div
      class="relative bg-gradient-to-br from-blue-600 to-blue-800 rounded-3xl p-8 shadow-2xl shadow-blue-900/20 overflow-hidden animate-fade-in ring-1 ring-white/10 text-white">
      <!-- Background Pulse Animation -->
      <div class="absolute -top-24 -right-24 w-64 h-64 bg-white/10 rounded-full blur-3xl animate-pulse"></div>

      <div class="relative z-10">
        <div class="flex justify-between items-start mb-6">
          <div>
            <span
              class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-white/20 text-white backdrop-blur-sm border border-white/10 mb-2">
              <i class="bi bi-broadcast me-2 animate-pulse"></i>المريض الحالي
            </span>
            <h2 class="text-6xl font-extrabold text-white mb-4 tracking-tight drop-shadow-sm">{{ current.name }}</h2>
            <div class="flex items-center text-blue-100 space-x-4 space-x-reverse text-lg">
              <span><i class="bi bi-person me-1 opacity-75"></i>العمر: <strong>{{ current.age }}</strong></span>
              <span class="text-blue-300">|</span>
              <span><i class="bi bi-gender-ambiguous me-1 opacity-75"></i>النوع: <strong>{{ 'ذكر' if current.gender ==
                  'male' else 'أنثى' }}</strong></span>
            </div>
          </div>

          <div class="text-end">
            <div class="text-white/80 text-sm font-mono mb-2">#{{ current.id }}</div>
            <span class="inline-flex items-center px-4 py-2 rounded-xl text-sm font-bold shadow-lg
                            {% if current.appointment_type == 'emergency' %}bg-red-500 text-white border border-red-400
                            {% elif current.appointment_type == 'follow_up' %}bg-yellow-500 text-white border border-yellow-400
                            {% else %}bg-green-500 text-white border border-green-400{% endif %}">
              {% if current.appointment_type == 'emergency' %}طوارئ
              {% elif current.appointment_type == 'follow_up' %}متابعة
              {% else %}كشف عادي{% endif %}
            </span>
          </div>
        </div>

        <div class="h-px bg-gradient-to-r from-transparent via-white/20 to-transparent my-6"></div>

        <div class="grid grid-cols-2 gap-4">
          <div class="bg-black/20 rounded-2xl p-4 backdrop-blur-sm border border-white/5">
            <div class="text-blue-200 text-sm mb-1">أولوية الحالة</div>
            <div class="text-3xl font-bold text-white font-mono flex items-center gap-2">
              {{ current.priority_score }}
              <i class="bi bi-question-circle text-sm text-blue-300 opacity-70"
                title="يتم حساب الأولوية بناءً على: نوع الحالة (طوارئ/متابعة) + الفئة العمرية (أطفال/كبار سن)"></i>
            </div>
          </div>
          <div class="bg-black/20 rounded-2xl p-4 backdrop-blur-sm border border-white/5">
            <div class="text-blue-200 text-sm mb-1">وقت الحضور</div>
            <div class="text-3xl font-bold text-white font-mono">{{ current.check_in_time | iraqtime }}</div>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div
      class="glass-card p-12 text-center border-dashed border-2 border-slate-300 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/30">
      <div class="mb-4 text-slate-400 dark:text-slate-600">
        <i class="bi bi-inbox text-6xl"></i>
      </div>
      <p class="text-xl text-slate-600 dark:text-slate-300 font-medium mb-1">لا يوجد مريض في العيادة حالياً</p>
      <p class="text-slate-500 text-sm">اضغط <strong>"استدعاء المريض التالي"</strong> للبدء</p>
    </div>
    {% endif %}

    <!-- Action Button -->
    <div class="mt-8">
      {% if current %}
      <form method="POST" action="{{ url_for('doctor_finish') }}">
        <div class="mb-6">
          <label for="diagnosis" class="input-label font-bold text-red-500">التشخيص / الملاحظات (لإنهاء الكشف المرجو
            التعبئة - اختياري)</label>
          <textarea name="diagnosis" id="diagnosis" rows="3"
            class="input-field border-red-200 focus:border-red-500 focus:ring-red-500/20"
            placeholder="اكتب ملاحظات التشخيص هنا ليتم تسجيلها في تاريخ المريض..."></textarea>
        </div>

        <button type="submit"
          class="w-full group bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-2xl font-bold py-4 px-6 text-xl shadow-lg shadow-red-500/30 transform transition-all duration-300 hover:-translate-y-1 flex items-center justify-center">
          <i class="bi bi-check2-circle text-2xl me-3 group-hover:scale-110 transition-transform"></i>
          إنهاء الكشف الحالي
        </button>
      </form>
      {% else %}
      <form method="POST" action="{{ url_for('doctor_start') }}">
        <button type="submit"
          class="w-full group bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-2xl font-bold py-4 px-6 text-xl shadow-lg shadow-green-500/30 transform transition-all duration-300 hover:-translate-y-1 flex items-center justify-center">
          <i class="bi bi-person-walking text-2xl me-3 group-hover:translate-x-1 transition-transform"></i>
          استدعاء المريض التالي للعيادة
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- ─── Next Patient Preview ─── -->
  <div class="lg:col-span-1">
    <div class="glass-card p-6 h-full border-t-4 border-t-slate-500 dark:border-t-slate-600">
      <h6 class="text-slate-500 dark:text-slate-400 font-bold uppercase text-xs tracking-wider mb-6 flex items-center">
        <i class="bi bi-people-fill me-2"></i>التالي في القائمة
      </h6>

      {% if next_patient %}
      <div
        class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-6 border border-slate-200 dark:border-slate-700/50 animate-fade-in hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-default shadow-sm">
        <div class="flex justify-between items-start mb-4">
          <h5 class="text-3xl font-extrabold text-slate-800 dark:text-white">{{ next_patient.name }}</h5>
          <span class="text-xs font-mono text-slate-500">#{{ next_patient.id }}</span>
        </div>

        <div class="space-y-3">
          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-500 dark:text-slate-400">العمر</span>
            <span class="text-slate-800 dark:text-white font-medium">{{ next_patient.age }}</span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-500 dark:text-slate-400">النوع</span>
            <span class="text-slate-800 dark:text-white font-medium">{{ 'ذكر' if next_patient.gender == 'male' else
              'أنثى' }}</span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-500 dark:text-slate-400">النوع</span>
            <span
              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold
                            {% if next_patient.appointment_type == 'emergency' %}bg-red-100 text-red-800 dark:bg-red-500/10 dark:text-red-400 border border-red-200 dark:border-red-500/20
                            {% elif next_patient.appointment_type == 'follow_up' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-500/10 dark:text-yellow-400 border border-yellow-200 dark:border-yellow-500/20
                            {% else %}bg-green-100 text-green-800 dark:bg-green-500/10 dark:text-green-400 border border-green-200 dark:border-green-500/20{% endif %}">
              {% if next_patient.appointment_type == 'emergency' %}طوارئ
              {% elif next_patient.appointment_type == 'follow_up' %}متابعة
              {% else %}كشف عادي{% endif %}
            </span>
          </div>

          <div class="border-t border-slate-200 dark:border-slate-700/50 pt-3 flex items-center justify-between mt-4">
            <span class="text-xs text-slate-500">الأولوية</span>
            <span class="text-lg font-bold text-blue-600 dark:text-blue-400 font-mono">{{ next_patient.priority_score
              }}</span>
          </div>
        </div>
      </div>
      {% else %}
      <div class="text-center py-10 text-muted">
        <i class="bi bi-emoji-smile text-3xl mb-3 block"></i>
        <p>لا يوجد مرضى في الانتظار</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ─── سجل المرضى الذين تم كشفهم اليوم ─── -->
{% if done_patients %}
<div class="mt-10 animate-fade-in">
  <h5 class="flex items-center text-slate-700 dark:text-slate-300 font-bold text-lg mb-4">
    <div class="p-2 bg-green-500/10 rounded-lg me-3 text-green-500">
      <i class="bi bi-clipboard2-check-fill text-xl"></i>
    </div>
    سجل الكشوفات اليوم
    <span
      class="ms-3 bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400 text-xs font-black px-2.5 py-0.5 rounded-full">{{
      done_patients | length }} مريض</span>
  </h5>

  <div class="glass-card overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-right text-sm">
        <thead
          class="bg-slate-50 dark:bg-slate-800/60 text-slate-600 dark:text-slate-400 text-xs uppercase font-bold border-b border-slate-200 dark:border-slate-700">
          <tr>
            <th class="px-4 py-3">#</th>
            <th class="px-4 py-3">اسم المريض</th>
            <th class="px-4 py-3">العمر</th>
            <th class="px-4 py-3">نوع الزيارة</th>
            <th class="px-4 py-3">وقت الحضور</th>
            <th class="px-4 py-3">التشخيص / الملاحظات</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 dark:divide-slate-700/50">
          {% for p in done_patients %}
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors">
            <!-- # -->
            <td class="px-4 py-3 text-slate-400 dark:text-slate-500 font-mono text-xs">{{ loop.index }}</td>
            <!-- الاسم -->
            <td class="px-4 py-3 font-bold text-slate-800 dark:text-white">{{ p.name }}</td>
            <!-- العمر -->
            <td class="px-4 py-3 text-slate-600 dark:text-slate-300">{{ p.age }}</td>
            <!-- نوع الزيارة -->
            <td class="px-4 py-3">
              {% if p.appointment_type == 'emergency' %}
              <span
                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700 dark:bg-red-500/10 dark:text-red-400 border border-red-200 dark:border-red-500/20">طوارئ</span>
              {% elif p.appointment_type == 'follow_up' %}
              <span
                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-yellow-100 text-yellow-700 dark:bg-yellow-500/10 dark:text-yellow-400 border border-yellow-200 dark:border-yellow-500/20">متابعة</span>
              {% else %}
              <span
                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700 dark:bg-green-500/10 dark:text-green-400 border border-green-200 dark:border-green-500/20">كشف
                عادي</span>
              {% endif %}
            </td>
            <!-- وقت الحضور -->
            <td class="px-4 py-3 text-slate-500 dark:text-slate-400 font-mono text-xs">{{ p.check_in_time | iraqtime }}
            </td>
            <!-- التشخيص -->
            <td class="px-4 py-3">
              {% if latest_diagnoses[p.id] %}
              <div class="flex items-start gap-2">
                <i class="bi bi-file-medical text-blue-400 mt-0.5 shrink-0"></i>
                <span class="text-slate-700 dark:text-slate-300 leading-relaxed">{{ latest_diagnoses[p.id] }}</span>
              </div>
              {% else %}
              <span class="text-slate-400 dark:text-slate-600 italic text-xs">— لم يُسجل تشخيص</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}