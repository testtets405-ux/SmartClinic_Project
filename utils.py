"""
================================================================================
خوارزمية الأولوية الذكية (utils.py)
================================================================================
الهدف المنهجي (للطالب):
كيف نمنع طابور العيادة من أن يكون "أعمى" كنظام (أول من يأتي، يُعالج أولاً)؟
الحل هنا هو بناء نظام (فرز طبي متقدم - Triage System) يتكون من مستويين:

المستوى 1 (طبقة الإلحاح - Urgency Tier):
    هذه الطبقة هي الجدار الصلب. مريض الطوارئ (Emergency) دائماً في الطبقة 1، 
    وهو يسبق أي مريض متابعة (طبقة 2) أو كشف عادي (طبقة 3)، حتى لو كان ينتظر لساعات!

المستوى 2 (معدل النقاط - Priority Score):
    هنا يحدث السحر التفصيلي "داخل نفس الطبقة".
    نُقيّم المريض بناءً على ذكاء الأرقام:
      1. السن (AgeBonus): الضعفاء (الشيوخ فوق 70، الرضع تحت 5) يُمنحون نقاطاً مجانية 
         تُقدمهم داخل الطابور احتراماً لضعفهم الجسدي ومناعتهم.
      2. عامل الانتظار (WaitingFactor): نعطي نقطة عن كل دقيقة انتظار، لمنع المريض 
         الشاب الذي يسجل مبكراً من البقاء في الخلف للأبد. يتم ترقيتُه تدريجياً ليتساوى مع الكبار الواصلين حديثاً.

الترتيب الرياضي النهائي: يتم بدمج المستويين مع وقت الحضور في قاعدة البيانات:
ORDER BY urgency_tier ASC, priority_score DESC, check_in_time ASC
================================================================================
"""

# ── طبقات الإلحاح (لا تتغير) ──────────────────────────────────────────────
URGENCY_TIER: dict[str, int] = {
    "emergency": 1,
    "follow_up": 2,
    "checkup":   3,
}


def get_urgency_tier(appointment_type: str) -> int:
    """إرجاع رقم طبقة الإلحاح لنوع الزيارة (1=طوارئ, 2=متابعة, 3=كشف)."""
    return URGENCY_TIER.get(appointment_type, 3)


def _age_bonus(age: int) -> int:
    """نقاط إضافية حسب الفئة العمرية."""
    if age >= 70:
        return 50
    if age >= 60:
        return 30
    if age <= 5:
        return 25
    if age <= 12:
        return 15
    return 0


def calculate_priority(age: int, appointment_type: str, waiting_minutes: int = 0) -> int:
    """
    حساب نقاط الأولوية للمريض داخل طبقته.

    القيمة تُستخدم لترتيب المرضى ضمن نفس طبقة الإلحاح فقط.
    لا تعكس الأولوية المطلقة — لذلك يجب دائماً الفرز بـ urgency_tier أولاً.

    Args:
        age:              عمر المريض بالسنوات
        appointment_type: 'emergency' | 'follow_up' | 'checkup'
        waiting_minutes:  مدة الانتظار الفعلية حتى الآن (تُحدَّث تلقائياً)

    Returns:
        int: نقاط الأولوية (الأعلى = يُخدَم أولاً ضمن طبقته)
    """
    bonus = _age_bonus(age)
    wait_factor = max(0, int(waiting_minutes))
    return bonus + wait_factor


def estimate_wait_time(queue_position: int, avg_minutes_per_patient: int = 12) -> int:
    """
    تقدير وقت الانتظار بالدقائق بناءً على موقع المريض في الطابور.

    افتراض: كل كشف يستغرق 12 دقيقة في المتوسط (قابل للتعديل).
    """
    if queue_position <= 0:
        return 0
    return queue_position * avg_minutes_per_patient
